angular.module("relcyApp",["ui.router","ui.bootstrap","bootstrapLightbox","angucomplete-alt"]),angular.module("relcyApp").config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider","$locationProvider","LightboxProvider",function(a,b,c,d,d,e){e.templateUrl="views/lightbox.html",b.otherwise("/"),a.state("home",{url:"/",templateUrl:"views/home.html",controller:"SearchController"}).state("details",{url:"/details",templateUrl:"views/detail.html",controller:"SearchController"})}]),angular.module("relcyApp").controller("SearchController",["$scope","$http","$rootScope","$location","$window","SearchService","$filter","anchorSmoothScroll","Lightbox",function(a,b,c,d,e,f,g,h,i){function j(a){return a?new Array(Math.floor(a)):[]}function k(a){return a%1>0}function l(){for(var b=0;b<a.types.length;b++)if(a.hasResults(a.types[b].content_type_enum,b)){a.showResult(a.types[b].content_type_enum,b);break}}a.selectedTypeIndex=0,a.selectedCategory,a.showDetailPage=!1,a.selected=0,a.showingResult=!1,a.hideMainSearch=!1,a.relatedSearches,a.defaultErrorImage="https://www.google.com/favicon.ico",a.query,a.showResult=function(b,c){a.selectedTypeIndex=b,a.resultByType=a.types[c]},a.hasResults=function(b,c){switch(b){case"ENTERTAINMENT_VIDEO_MOVIE":return a.types[c]&&a.types[c].searchResultRelcy&&a.types[c].searchResultRelcy.results&&a.types[c].searchResultRelcy.results.length;case"WEB_VIDEOS":return a.types[c]&&a.types[c].videoSearchResult&&a.types[c].videoSearchResult.videoSearchResults&&a.types[c].videoSearchResult.videoSearchResults.length;case"WEB":return a.types[c]&&a.types[c].webSearchResult&&a.types[c].webSearchResult.searchResults&&a.types[c].webSearchResult.searchResults.length;case"APP":return a.types[c]&&a.types[c].searchResultRelcy&&a.types[c].searchResultRelcy.results&&a.types[c].searchResultRelcy.results.length;case"RELATED_SEARCHES":return a.types[c]&&a.types[c].relatedSearchesResult&&a.types[c].relatedSearchesResult.relatedSearchResults&&a.types[c].relatedSearchesResult.relatedSearchResults.length;default:return!1}},a.addScores=function(a){return a?(angular.forEach(a.auto_complete_response.auto_complete_item,function(a){a.scoreArray=j(a.score),a.showHalfRating=k(a.score)}),a.auto_complete_response):void 0},a.onInputChange=function(b){a.query=b},a.searchForSelection=function(b){b&&b.title&&a.search(b.title)},a.goForRelatedSearch=function(b){angular.element(document.querySelector("#members")).children().children()[0].value=b,a.search(b)},a.search=function(b){b&&(a.query=b,f.getSearchDetails(b).then(function(b){return a.showDetailPage=!1,a.showingResult=!0,a.result=b.search_response,a.result.verticalResult?(a.searchResults=f.transformSearchResults(a.result.verticalResult,a),a.selectedCategory=a.searchResults[0].key,a.types=a.result.verticalResult,void l()):void(a.showingResult=!1)},function(b){a.showingResult=!1,a.gridMessage="Error while loading data"}))},a.clearSearchInput=function(b){a.hideMainSearch=!1,a.showDetailPage=!1,a.$broadcast("angucomplete-alt:clearInput","members"),a.showingResult=!1,a.$broadcast("angucomplete-alt:clearInput",b)},a.scrollTo=function(b){a.selectedCategory=b,"container"==b?(a.showTopAnchor=!1,a.searchResults.length>0&&(a.selectedCategory=a.searchResults[0].key)):a.showTopAnchor=!0,d.hash(b),h.scrollTo(b)},a.onAutoCompleteSelect=function(b){b&&(b.originalObject.lookIds&&b.originalObject.lookIds[0]?a.showDetails(b):a.searchForSelection(b))},a.incrementAndScroll=function(b){var c=b.values;b.maxIndex=b.maxIndex+b.incrementBy;var d,e;c[b.maxIndex]?(d=c[b.maxIndex],e=b.maxIndex):(e=b.length-1,d=c[e]),e=b.key+e,$timeout(function(){a.scrollTo(e)},1100)},a.showDetails=function(b){a.showingResult=!1,a.hideMainSearch=!0;var c;return b.relcy_id&&b.relcy_id.entity_id?c=b.relcy_id.entity_id:b.originalObject.lookIds&&b.originalObject.lookIds[0]&&(c=b.originalObject.lookIds[0]),c?(a.showDetailPage=!1,void f.getEntityDetails(c).then(function(c){a.showDetailPage=!0,f.selectedItem=b,a.itemDetails=f.transformDetails(c),a.searchResults=a.itemDetails.categories,a.searchResults.length>0&&(a.selectedCategory=a.searchResults[0].key)},function(a){console.log("Error while fetching details!!!")})):void console.log("Relcy id not found!")},a.openCastLightbox=function(b,c,d){if(i.type=c,i.data=b,"VIDEO"==c&&(i.data={value:"https://www.youtube.com/embed/XGSy3_Czz8k?autoplay=1"}),"IMAGES"==c){a.images=[];for(var e=0;e<b.length;e++)a.images.push({url:b[e].contentUrl,caption:b[e].title,thumbUrl:b[e].thumbnailUrl,dimensions:b[e].dimensions});i.openModal(a.images,d)}else i.openModal([i.data],0)},e.navigator.geolocation.getCurrentPosition(function(b){a.$apply(function(){f.position=b,console.log(b)})},function(a){alert(a)})}]),angular.module("relcyApp").service("SearchService",["$timeout","$q","$http",function(a,b,c){this.searchResult=[],this.position,this.defaultLoc={lat:"37.762759",lng:"-122.408934"};var d=this;this.getGeoLocation=function(){try{return{lat:d.position.coords.latitude,lng:d.position.coords.longitude}}catch(a){return d.defaultLoc}},this.getSearchDetails=function(a){var e=d.getGeoLocation(),f=b.defer();return c.get("http://dev-w.relcy.com/search?lat="+e.lat+"&lng="+e.lng+"&sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1&query="+a).success(function(a){f.resolve(a)}).error(function(a,b){f.reject(a)}),f.promise},this.getEntityDetails=function(a){var e=d.getGeoLocation(),f=b.defer();return c.get("http://dev-w.relcy.com/detail?lat="+e.lat+"&lng="+e.lng+"&sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1&id=look:3b41f9b9").success(function(a){f.resolve(a)}).error(function(a,b){f.reject(a)}),f.promise},this.search=function(a){var b="b9a30926-e912-11e4-b02c-1681e6b88ec1",e=d.getGeoLocation(),a=a,f=c({method:"get",url:"/test/arc-response-2015_Apr_24_12-21-31.json?sessionId="+b+"&lat="+e.lat+"&lng="+e.lng+"&query="+a});return f.then(this.handleSuccess,this.handleError)},this.transformDetails=function(a){var b={};b.categories=[],a=a.detail_response;try{var c=a.results[0].link;c&&c.length>0&&d.insertReviewsAndWatchesAndShowtimes(b,c,a)}catch(e){console.log("Links not available")}if(a){var f=a.search_result_collection;if(f){if("ENTERTAINMENT_AUDIO"==a.results[0].content_type_enum)try{b.audioResult=a.results[0].content_type_enum,b.categories.push({key:"details_audio",keyTitle:"Audio"})}catch(e){console.log("no audio results found")}else try{b.moviesResult=a.results[0].content_type_enum,b.categories.push({key:"details_movies",keyTitle:"Movies"})}catch(e){console.log("no movie results found")}try{b.webResults=f.webSearchResult.searchResults,b.webResults.maxIndex=3,b.categories.push({key:"details_web",keyTitle:"Web"})}catch(e){console.log("no web results found")}try{b.imageResults=f.imageSearchResult.imageSearchResults,b.imageResults.maxIndex=3,b.categories.push({key:"details_images",keyTitle:"Images"})}catch(e){console.log("no image results found")}try{b.videoResults=f.videoSearchResult.videoSearchResults,b.videoResults.maxIndex=5,b.categories.push({key:"details_videos",keyTitle:"Videos"})}catch(e){console.log("no video results found")}}try{b.duration=a.results[0].entity_data.entertainment_data.movie_data.length}catch(e){console.log("duration unknown")}try{b.releaseYear=a.results[0].entity_data.entertainment_data.common_data.release_year}catch(e){console.log("release year unknown")}try{b.title=a.results[0].entity_data.common_data.name}catch(e){console.log("title not found/unknown")}try{b.story=a.results[0].entity_data.common_data.summary}catch(e){console.log("title not found/unknown")}try{b.parentalRating=a.results[0].entity_data.entertainment_data.common_data.parental_rating}catch(e){console.log("parentalRating not found/unknown")}try{b.cast=a.results[0].entity_data.entertainment_data.common_data.performer}catch(e){console.log("cast not found/unknown")}try{b.cast?b.cast.push(a.results[0].entity_data.entertainment_data.common_data.director):b.cast=[a.results[0].entity_data.entertainment_data.common_data.director]}catch(e){console.log("director not found/unknown")}try{b.genre=a.results[0].entity_data.entertainment_data.common_data.genre.join(),b.genre=b.genre.replace(/&amp;/g,"&")}catch(e){console.log("cast not found/unknown")}}return b},this.transformSearchResults=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d].content_type_enum,f=void 0,g=void 0,h=void 0,i=void 0,j=void 0;switch(e){case"ENTERTAINMENT_VIDEO_MOVIE":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="Movies",h="ENTERTAINMENT_VIDEO_MOVIE",i=2,j=2);break;case"ENTERTAINMENT_VIDEO_TVSHOW":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="TV Shows",h="ENTERTAINMENT_VIDEO_TVSHOW",i=2,j=2);break;case"WEB_VIDEOS":a[d]&&a[d].videoSearchResult&&a[d].videoSearchResult.videoSearchResults&&a[d].videoSearchResult.videoSearchResults.length&&(f=a[d].videoSearchResult.videoSearchResults,g="Videos",h="WEB_VIDEOS",i=2,j=2);break;case"WEB_IMAGES":a[d]&&a[d].imageSearchResult&&a[d].imageSearchResult.imageSearchResults&&a[d].imageSearchResult.imageSearchResults.length&&(f=a[d].imageSearchResult.imageSearchResults,g="Images",h="WEB_IMAGES",i=2,j=2);break;case"WEB":a[d]&&a[d].webSearchResult&&a[d].webSearchResult.searchResults&&a[d].webSearchResult.searchResults.length&&(f=a[d].webSearchResult.searchResults,g="Web",h="WEB",i=10,j=10);break;case"WEB_NEWS":a[d]&&a[d].newsSearchResult&&a[d].newsSearchResult.newsSearchResults&&a[d].newsSearchResult.newsSearchResults.length&&(f=a[d].newsSearchResult.newsSearchResults,g="News",h="WEB_NEWS",i=10,j=10);break;case"APP":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="App",h="APP",i=2,j=2);break;case"RELATED_SEARCHES":a[d]&&a[d].relatedSearchesResult&&a[d].relatedSearchesResult.relatedSearchResults&&a[d].relatedSearchesResult.relatedSearchResults.length&&(b.relatedSearches=a[d].relatedSearchesResult.relatedSearchResults),f=void 0;break;case"ENTERTAINMENT_AUDIO":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="Songs",h="ENTERTAINMENT_AUDIO",i=2,j=2);break;default:continue}f&&c.push({key:e,values:f,keyTitle:g,maxIndex:i,incrementBy:j,template:h})}return c},this.insertReviewsAndWatchesAndShowtimes=function(a,b,c){a.reviews=[],a.watches=[],angular.forEach(b,function(b){try{var c=b.app_result.result_data.action;switch(c){case"Reviews":a.reviews.push(b);break;case"Watch":a.watches.push(b)}}catch(d){console.log("invalid link")}});var d=[];try{d=c.results[0].entity_data.entertainment_data.movie_data.tv_showtime.showtimes}catch(e){console.log("No tv shows");try{d=c.results[0].entity_data.entertainment_data.movie_data.theatre_showtime.showtimes}catch(e){console.log("No movie shows")}}a.showTimes=[],angular.forEach(d,function(b){for(var c=[],d=0;d<b.shows.days.length;d++){for(var e,f=new Date(b.shows.days[d].date-0),g=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate(),h=!1,i=0;i<c.length;i++)c[i].strDate==g&&(h=!0,e=c[i]);h?e.hours=e.hours.concat(b.shows.days[d].hours):c.push({title:b.playing_entity.title,strDate:g,hours:b.shows.days[d].hours,date:b.shows.days[d].date})}a.showTimes.push(c)})},this.hasLinkType=function(a,b){for(var c=b.results[0].app_action,d=0;d<c.length;d++)if(c[d]==a)return!0},this.handleError=function(a){return console.log(a),404==a.status&&"Result not available."==a.data?a:(console.log(a),b.reject(angular.isObject(a.data)&&a.data.message?a:a))},this.handleSuccess=function(a){var b=a.data;return b}}]),angular.module("relcyApp").service("anchorSmoothScroll",function(){this.scrollTo=function(a){function b(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}function c(a){for(var b=document.getElementById(a),c=b.offsetTop,d=b;d.offsetParent&&d.offsetParent!=document.body;)d=d.offsetParent,c+=d.offsetTop;return c}var d=b(),e=c(a),f=e>d?e-d:d-e;if(100>f)return void scrollTo(0,e);var g=Math.round(f/100);g>=20&&(g=20),g=15;var h=Math.round(f/25),i=e>d?d+h:d-h;e-=100;var j=0;if(e>d)for(var k=d;e>k;k+=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i+=h,i>e&&(i=e),j++;else for(var k=d;k>e;k-=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i-=h,e>i&&(i=e),j++}}),angular.module("relcyApp").directive("errSrc",function(){return{link:function(a,b,c){b.bind("error",function(){c.src!=c.errSrc&&c.$set("src",c.errSrc)}),c.$observe("ngSrc",function(a){!a&&c.errSrc&&c.$set("src",c.errSrc)})}}});