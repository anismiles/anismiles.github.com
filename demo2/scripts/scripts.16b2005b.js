function getMapUrl(a,b,c){return c="Bars"==c||"bars"==c?"-bar":"","http://api.tiles.mapbox.com/v4/hunterowens2.m0lnepeh/pin-l"+c+"+3397DA("+a.longitude+","+a.latitude+",1)/"+a.longitude+","+a.latitude+",13/898x359.png?access_token="+b}angular.module("relcyApp",["ui.router","ui.bootstrap","bootstrapLightbox","angucomplete-alt"]),angular.module("relcyApp").config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider","$locationProvider","$sceProvider","LightboxProvider",function(a,b,c,d,d,e,f){f.templateUrl="views/lightbox.html",b.otherwise("/"),a.state("home",{url:"/",templateUrl:"views/home.html",controller:"SearchController"}),e.enabled(!1)}]),angular.module("relcyApp").controller("SearchController",["$scope","$http","$rootScope","$location","$window","$timeout","SearchService","$filter","anchorSmoothScroll","Lightbox",function(a,b,c,d,e,f,g,h,i,j){function k(a){return a?new Array(Math.floor(a)):[]}function l(a){return a%1>0}function m(){for(var b=0;b<a.types.length;b++)if(a.hasResults(a.types[b].content_type_enum,b)){a.showResult(a.types[b].content_type_enum,b);break}}var n="img-no-min/Lighthouse.png";a.selectedTypeIndex=0,a.selectedCategory,a.showDetailPage=!1,a.selected=0,a.showingResult=!1,a.hideMainSearch=!1,a.relatedSearches,a.defaultErrorImage="../../favicon.ico",a.showTopAnchor=!1,a.itemType,a.itemDetails,a.query,a.showResult=function(b,c){a.selectedTypeIndex=b,a.resultByType=a.types[c]},a.hasResults=function(b,c){switch(b){case"ENTERTAINMENT_VIDEO_MOVIE":return a.types[c]&&a.types[c].searchResultRelcy&&a.types[c].searchResultRelcy.results&&a.types[c].searchResultRelcy.results.length;case"WEB_VIDEOS":return a.types[c]&&a.types[c].videoSearchResult&&a.types[c].videoSearchResult.videoSearchResults&&a.types[c].videoSearchResult.videoSearchResults.length;case"WEB":return a.types[c]&&a.types[c].webSearchResult&&a.types[c].webSearchResult.searchResults&&a.types[c].webSearchResult.searchResults.length;case"APP":return a.types[c]&&a.types[c].searchResultRelcy&&a.types[c].searchResultRelcy.results&&a.types[c].searchResultRelcy.results.length;case"RELATED_SEARCHES":return a.types[c]&&a.types[c].relatedSearchesResult&&a.types[c].relatedSearchesResult.relatedSearchResults&&a.types[c].relatedSearchesResult.relatedSearchResults.length;case"LOCAL_BUSINESS":return a.types[c]&&a.types[c].relatedSearchesResult&&a.types[c].relatedSearchesResult.relatedSearchResults&&a.types[c].relatedSearchesResult.relatedSearchResults.length;default:return!1}},a.addScores=function(a){return a?(angular.forEach(a.auto_complete_response.auto_complete_item,function(a){a.scoreArray=k(a.score),a.showHalfRating=l(a.score)}),a.auto_complete_response):void 0},a.addScoresToAppResluts=function(a){return a?(angular.forEach(a,function(a){a.scoreArray=k(a.app_result[0].score),a.showHalfRating=l(a.app_result[0].score)}),a):void 0},a.addScoresToPlaceResluts=function(a){return a?(angular.forEach(a,function(a){try{var b,c=a.entity_data.common_data.display_rating[0],d=c.rating_style;"STAR"==d?(b=c.rating,a.scoreArray=k(b),a.showHalfRating=l(b)):(a.rating=c.rating+"/"+c.max_rating,a.showStrRating=!0),a.ratingSource=c.source}catch(e){console.log("rating not avlbl for this one")}}),a):void 0},a.addScoresToVideoMovies=function(a){return a?(angular.forEach(a,function(a){var b=a.score/20;a.scoreArray=k(b),a.showHalfRating=l(b)}),a):void 0},a.onInputChange=function(b){a.query=b},a.searchForSelection=function(b){b&&b.title&&a.search(b.title)},a.goForRelatedSearch=function(b){a.$broadcast("angucomplete-alt:clearInput","members"),f(function(){angular.element(document.querySelector("#members")).children().children()[0].value=b},250),a.search(b),a.query=b},a.search=function(b){b&&(a.hasLocalBusiness=!1,c.hideLoader=!1,a.searchResults=void 0,a.relatedSearches=void 0,g.getSearchDetails(b).then(function(b){return a.showDetailPage=!1,a.showingResult=!0,a.result=b.search_response,a.result.verticalResult?(a.searchResults=g.transformSearchResults(a.result.verticalResult,a),a.selectedCategory=a.searchResults[0].key,a.types=a.result.verticalResult,m(),void(c.hideLoader=!0)):void(a.showingResult=!1)},function(b){a.showingResult=!1,a.gridMessage="Error while loading data",c.hideLoader=!0}))},a.reload=function(){window.location.reload()},a.clearSearchInput=function(b){a.hideMainSearch=!1,a.showDetailPage=!1,a.$broadcast("angucomplete-alt:clearInput","members"),a.showingResult=!1,a.$broadcast("angucomplete-alt:clearInput",b)},a.getBaseUrl=function(){return g.BASE_URL},a.gotoLink=function(a){a&&e.open(a,"_blank")},a.scrollTo=function(b){if(a.selectedCategory=b,"container"==b)a.showTopAnchor=!1,a.searchResults.length>0&&(a.selectedCategory=a.searchResults[0].key);else try{a.searchResults[0].key==b?a.showTopAnchor=!1:a.showTopAnchor=!0}catch(c){console.log("nothing there in first category!")}d.hash(b),i.scrollTo(b)},a.onAutoCompleteSelect=function(b){b&&(b.originalObject.lookIds&&b.originalObject.lookIds[0]?a.showDetails(b):a.searchForSelection(b))},a.incrementAndScroll=function(a){a.maxIndex=a.maxIndex+a.incrementBy},a.showDetails=function(b){a.showingResult=!1,a.hideMainSearch=!0,b.content_type_enum?a.itemType=b.content_type_enum:b.originalObject.content_type_enum&&(a.itemType=b.originalObject.content_type_enum);var d;return b.relcy_id&&b.relcy_id.entity_id?d=b.relcy_id:b.originalObject.lookIds&&b.originalObject.lookIds[0]&&(d={entity_id:b.originalObject.lookIds[0],cipher_id:b.originalObject.entity_id}),d?(c.hideLoader=!1,a.showDetailPage=!1,g.getEntityDetails(d).then(function(d){a.showDetailPage=!0,g.selectedItem=b,a.itemDetails=g.transformDetails(d),a.searchResults=a.itemDetails.categories;var e=g.transformQuery(a.itemDetails,a.itemType);if("LOCAL_BUSINESS"==a.itemType){try{a.itemDetails.distance=b.entity_data.local_data.location_info.display_distance}catch(f){console.log("distance unknown")}a.bannerUrl=getMapUrl(a.itemDetails.mapinfo,g.ACCESS_TOKEN,a.itemDetails.categoryHero)}else g.getBannerUrl(e).then(function(b){b?a.bannerUrl=b:a.bannerUrl=n},function(a){console.log("Error while fetching banner image url")});a.searchResults.length>0&&(a.selectedCategory=a.searchResults[0].key),c.hideLoader=!0},function(a){console.log("Error while fetching details!!!"),c.hideLoader=!0}),void 0):void console.log("Relcy id not found!")},a.openCastLightbox=function(b,c,d){if(j.type=c,j.data=b,"VIDEO"==c){for(var e=0;e<b.length;e++)try{if(b[e].contentUrl.indexOf("youtube")>-1){var f=b[e].contentUrl.replace("watch?v=","embed/");f+="?autoplay=1",j.data={value:f,title:b[e].title,duration:b[e].duration};break}}catch(g){console.log("something went wrong!")}j.data.value||(j.data={value:b[0].contentUrl})}if("IMAGES"==c){a.images=[];for(var e=0;e<b.length;e++)a.images.push({url:b[e].contentUrl,caption:b[e].title,thumbUrl:b[e].thumbnailUrl,dimensions:b[e].dimensions});j.openModal(a.images,d)}else j.openModal([j.data],0)},e.navigator.geolocation.getCurrentPosition(function(b){a.$apply(function(){g.position=b,console.log(b)})},function(a){}),c.hideSearchDropdown=function(a){angular.element(document.querySelector("#members")).children()[0].classList.remove("angucomplete-dropdown-visible")},c.hideLoader=!0,a.hasLocalBusiness=!1}]),angular.module("relcyApp").service("SearchService",["$timeout","$q","$http",function(a,b,c){this.searchResult=[],this.position,this.BASE_URL="https://staging-w.relcy.com",this.ACCESS_TOKEN="pk.eyJ1IjoiaHVudGVyb3dlbnMyIiwiYSI6ImI5dzd0YWMifQ.fFpJUocWQigRBbrLOqU4oQ",this.defaultLoc={lat:"37.762759",lng:"-122.408934"};var d=this;this.getGeoLocation=function(){try{return{lat:d.position.coords.latitude,lng:d.position.coords.longitude}}catch(a){return d.defaultLoc}},this.getSearchDetails=function(a){var e=d.getGeoLocation(),f=b.defer();return c.get(d.BASE_URL+"/search?lat="+e.lat+"&lng="+e.lng+"&sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1&query="+a).success(function(a){f.resolve(a)}).error(function(a,b){f.reject(a)}),f.promise},this.getEntityDetails=function(a){var e=(d.getGeoLocation(),b.defer()),f=a;return c({method:"POST",url:d.BASE_URL+"/detail?sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1",data:f}).success(function(a){e.resolve(a)}).error(function(a,b){e.reject(a)}),e.promise},this.getBannerUrl=function(a){var e=b.defer();return c.get(d.BASE_URL+"/imagefetcher?sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1&query="+a).success(function(a){e.resolve(a)}).error(function(a,b){e.reject(a)}),e.promise},this.transformDetails=function(a){var b={};if(b.categories=[],a=a.detail_response){var c=a.search_result_collection;if(c){if("ENTERTAINMENT_AUDIO"==a.results[0].content_type_enum)try{b.audioResult=a.results[0].content_type_enum,b.categories.push({key:"details_audio",keyTitle:"Audio"})}catch(e){console.log("no audio results found")}else if("LOCAL_BUSINESS"==a.results[0].content_type_enum){try{b.placesResult=a.results[0].content_type_enum,b.categories.push({key:"details_places",keyTitle:"Places"})}catch(e){console.log("no places results found")}try{var f=a.results[0].link;f&&f.length>0&&d.getAppActionForPlaces(b,f,a)}catch(e){console.log("Links not available")}try{b.displayRating=a.results[0].entity_data.common_data.display_rating}catch(e){console.log("rating not found/unknown")}try{b.title=a.results[0].entity_data.common_data.name}catch(e){console.log("title not found/unknown")}try{b.category=a.results[0].entity_data.local_data.category.toString()}catch(e){console.log("category unknown")}try{b.categoryHero=a.results[0].entity_data.local_data.category[0]}catch(e){console.log("category unknown")}try{b.mapinfo=a.results[0].entity_data.local_data.location_info}catch(e){console.log("address unknown")}try{b.hours=a.results[0].entity_data.local_data.business_hours.days}catch(e){console.log("businessHours unknown")}try{b.call=a.results[0].entity_data.common_data.contact_info.phone_with_type}catch(e){console.log("businessHours unknown")}try{b.openStatus=a.results[0].entity_data.local_data.open_status}catch(e){console.log("openStatus unknown")}try{b.priceRange=a.results[0].entity_data.local_data.price_range.display_price_range}catch(e){console.log("priceRange unknown")}}else try{b.moviesResult=a.results[0].content_type_enum,b.displayRating=a.results[0].entity_data.common_data.display_rating,b.categories.push({key:"details_movies",keyTitle:"Movies"});try{var f=a.results[0].link;f&&f.length>0&&d.insertReviewsAndWatchesAndShowtimes(b,f,a)}catch(e){console.log("Links not available")}try{b.duration=a.results[0].entity_data.entertainment_data.movie_data.length}catch(e){console.log("duration unknown")}try{b.releaseYear=a.results[0].entity_data.entertainment_data.common_data.release_year}catch(e){console.log("release year unknown")}try{b.title=a.results[0].entity_data.common_data.name}catch(e){console.log("title not found/unknown")}try{b.story=a.results[0].entity_data.common_data.summary}catch(e){console.log("title not found/unknown")}try{b.parentalRating=a.results[0].entity_data.entertainment_data.common_data.parental_rating}catch(e){console.log("parentalRating not found/unknown")}try{b.cast=a.results[0].entity_data.entertainment_data.common_data.performer}catch(e){console.log("cast not found/unknown")}try{b.cast?b.cast.push(a.results[0].entity_data.entertainment_data.common_data.director):b.cast=[a.results[0].entity_data.entertainment_data.common_data.director]}catch(e){console.log("director not found/unknown")}try{b.genre=a.results[0].entity_data.entertainment_data.common_data.genre.join(),b.genre=b.genre.replace(/&amp;/g,"&")}catch(e){console.log("cast not found/unknown")}}catch(e){console.log("no movie results found")}try{b.webResults=c.webSearchResult.searchResults,b.webResults.maxIndex=10,b.categories.push({key:"details_web",keyTitle:"Web"})}catch(e){console.log("no web results found")}try{b.imageResults=c.imageSearchResult.imageSearchResults,b.imageResults.maxIndex=4,b.categories.push({key:"details_images",keyTitle:"Images"})}catch(e){console.log("no image results found")}try{b.videoResults=c.videoSearchResult.videoSearchResults,b.videoResults.maxIndex=5,b.categories.push({key:"details_videos",keyTitle:"Videos"})}catch(e){console.log("no video results found")}try{b.placesResults=c.placesSearchResult.placesSearchResult,b.placesResults.maxIndex=6,b.categories.push({key:"details_places",keyTitle:"Places"})}catch(e){console.log("no places results found")}}}return b},this.transformSearchResults=function(a,b){for(var c=[],e=0;e<a.length;e++){var f=a[e].content_type_enum,g=void 0,h=void 0,i=void 0,j=void 0,k=void 0;switch(f){case"ENTERTAINMENT_VIDEO_MOVIE":a[e]&&a[e].searchResultRelcy&&a[e].searchResultRelcy.results&&a[e].searchResultRelcy.results.length&&(g=a[e].searchResultRelcy.results,h="Movies",i="ENTERTAINMENT_VIDEO_MOVIE",j=4,k=4,b.addScoresToVideoMovies(g));break;case"ENTERTAINMENT_VIDEO_TVSHOW":a[e]&&a[e].searchResultRelcy&&a[e].searchResultRelcy.results&&a[e].searchResultRelcy.results.length&&(g=a[e].searchResultRelcy.results,h="TV Shows",i="ENTERTAINMENT_VIDEO_TVSHOW",j=4,k=4,b.addScoresToVideoMovies(g));break;case"WEB_VIDEOS":a[e]&&a[e].videoSearchResult&&a[e].videoSearchResult.videoSearchResults&&a[e].videoSearchResult.videoSearchResults.length&&(g=a[e].videoSearchResult.videoSearchResults,h="Videos",i="WEB_VIDEOS",j=3,k=3);break;case"WEB_IMAGES":a[e]&&a[e].imageSearchResult&&a[e].imageSearchResult.imageSearchResults&&a[e].imageSearchResult.imageSearchResults.length&&(g=a[e].imageSearchResult.imageSearchResults,h="Images",i="WEB_IMAGES",j=4,k=4);break;case"WEB":a[e]&&a[e].webSearchResult&&a[e].webSearchResult.searchResults&&a[e].webSearchResult.searchResults.length&&(g=a[e].webSearchResult.searchResults,h="Web",i="WEB",j=10,k=10);break;case"WEB_NEWS":a[e]&&a[e].newsSearchResult&&a[e].newsSearchResult.newsSearchResults&&a[e].newsSearchResult.newsSearchResults.length&&(g=a[e].newsSearchResult.newsSearchResults,h="News",i="WEB_NEWS",j=10,k=10);break;case"APP":a[e]&&a[e].searchResultRelcy&&a[e].searchResultRelcy.results&&a[e].searchResultRelcy.results.length&&(g=a[e].searchResultRelcy.results,h="App",i="APP",j=2,k=2,b.addScoresToAppResluts(g));break;case"RELATED_SEARCHES":a[e]&&a[e].relatedSearchesResult&&a[e].relatedSearchesResult.relatedSearchResults&&a[e].relatedSearchesResult.relatedSearchResults.length&&(b.relatedSearches=a[e].relatedSearchesResult.relatedSearchResults),g=void 0;break;case"ENTERTAINMENT_AUDIO":a[e]&&a[e].searchResultRelcy&&a[e].searchResultRelcy.results&&a[e].searchResultRelcy.results.length&&(g=a[e].searchResultRelcy.results,h="Songs",i="ENTERTAINMENT_AUDIO",j=1,k=1,b.addScoresToVideoMovies(g));break;case"LOCAL_BUSINESS":if(a[e]&&a[e].searchResultRelcy&&a[e].searchResultRelcy.results&&a[e].searchResultRelcy.results.length){g=a[e].searchResultRelcy.results,h="Places",i="LOCAL_BUSINESS",j=6,k=6,b.addScoresToPlaceResluts(g),b.hasLocalBusiness=!0;var l,m="http://api.tiles.mapbox.com/v4/hunterowens2.m0lnepeh/";if(g.length>1)for(var n=0;n<g.length-1;n++)try{l=g[n].entity_data.local_data.location_info,m+="pin-m+3397DA("+l.longitude+","+l.latitude+"),"}catch(o){console.log("Location not present!")}l=g[g.length-1].entity_data.local_data.location_info;try{m+="pin-m+3397DA("+l.longitude+","+l.latitude+")/"+l.longitude+","+l.latitude+",12/380x350.png?access_token="+d.ACCESS_TOKEN}catch(o){console.log("Location not present!")}b.locationUrl=m}break;default:continue}g&&c.push({key:f,values:g,keyTitle:h,maxIndex:j,incrementBy:k,template:i})}return c},this.getAppActionForPlaces=function(a,b,c){a.reviews=[],a.delivery=[],a.social=[],a.reserve=[],a.deals=[],a.call=[],a.map=[],a.getThere=[],a.menu=[],angular.forEach(b,function(b){try{var c=b.app_result.result_data.action;switch(c.toLowerCase()){case"reviews":a.reviews.push(b);break;case"delivery":a.delivery.push(b);break;case"social":a.social.push(b);break;case"reserve":a.reserve.push(b);break;case"deals":a.deals.push(b);break;case"call":a.call.push(b);break;case"map":a.map.push(b);break;case"get there":a.getThere.push(b);break;case"menu":a.menu.push(b)}}catch(d){console.log("invalid link")}})},this.insertReviewsAndWatchesAndShowtimes=function(a,b,c){a.reviews=[],a.watches=[],angular.forEach(b,function(b){try{var c=b.app_result.result_data.action;switch(c){case"Reviews":a.reviews.push(b);break;case"Watch":a.watches.push(b)}}catch(d){console.log("invalid link")}});var d=[];try{d=c.results[0].entity_data.entertainment_data.movie_data.tv_showtime.showtimes}catch(e){console.log("No tv shows");try{d=c.results[0].entity_data.entertainment_data.movie_data.theatre_showtime.showtimes}catch(e){console.log("No movie shows")}}a.showTimes=[],angular.forEach(d,function(b){for(var c=[],d=0;d<b.shows.days.length;d++){for(var e,f=new Date(b.shows.days[d].date-0),g=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate(),h=!1,i=0;i<c.length;i++)c[i].strDate==g&&(h=!0,e=c[i]);h?e.hours=e.hours.concat(b.shows.days[d].hours):c.push({title:b.playing_entity.title,strDate:g,hours:b.shows.days[d].hours,date:b.shows.days[d].date})}a.showTimes.push(c)})},this.hasLinkType=function(a,b){for(var c=b.results[0].app_action,d=0;d<c.length;d++)if(c[d]==a)return!0},this.transformQuery=function(a,b){switch(b){case"ENTERTAINMENT_VIDEO_MOVIE":return a.title+"+"+a.releaseYear;case"WEB_VIDEOS":break;case"LOCAL_BUSINESS":return a.categoryHero;default:return!1}},this.handleError=function(a){return console.log(a),404==a.status&&"Result not available."==a.data?a:(console.log(a),b.reject(angular.isObject(a.data)&&a.data.message?a:a))},this.handleSuccess=function(a){var b=a.data;return b}}]),angular.module("relcyApp").service("anchorSmoothScroll",function(){this.scrollTo=function(a){function b(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}function c(a){for(var b=document.getElementById(a),c=b.offsetTop,d=b;d.offsetParent&&d.offsetParent!=document.body;)d=d.offsetParent,c+=d.offsetTop;return c}var d=b(),e=c(a),f=e>d?e-d:d-e;if(100>f)return void scrollTo(0,e);var g=Math.round(f/100);g>=20&&(g=20),g=15;var h=Math.round(f/25),i=e>d?d+h:d-h;e-=106;var j=0;if(e>d)for(var k=d;e>k;k+=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i+=h,i>e&&(i=e),j++;else for(var k=d;k>e;k-=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i-=h,e>i&&(i=e),j++}}),angular.module("relcyApp").filter("hourmins",function(){return function(a){if(a){var b=a.indexOf("min");if(a.indexOf("hr")>0)return a;if(b>0){var c=parseInt(a.substring(0,b),0),d=Math.floor(c/60),e="";return d>0&&(e+=d+" hr "),e=e+c%60+" min"}var f=parseInt(a,0),d=Math.floor(f/60),e="";return d>0&&(e+=d+" hr "),e=e+f%60+" min"}}}),angular.module("relcyApp").directive("errSrc",function(){return{link:function(a,b,c){b.bind("error",function(){c.src!=c.errSrc&&c.$set("src",c.errSrc)}),c.$observe("ngSrc",function(a){!a&&c.errSrc&&c.$set("src",c.errSrc)})}}});