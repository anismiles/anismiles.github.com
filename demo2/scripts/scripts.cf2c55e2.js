angular.module("relcyApp",["ui.router","ui.bootstrap","bootstrapLightbox","angucomplete-alt","ui.thumbnail"]),angular.module("relcyApp").config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider","$locationProvider","$sceProvider","LightboxProvider","ThumbnailServiceProvider",function(a,b,c,d,d,e,f,g){g.defaults.width=150,g.defaults.height=150,f.templateUrl="views/lightbox.html",b.otherwise("/"),a.state("home",{url:"/",templateUrl:"views/home.html",controller:"SearchController"}),e.enabled(!1)}]),angular.module("relcyApp").controller("SearchController",["$scope","$http","$rootScope","$location","$window","$timeout","SearchService","$filter","anchorSmoothScroll","Lightbox",function(a,b,c,d,e,f,g,h,i,j){function k(a){return a?new Array(Math.floor(a)):[]}function l(a){return a%1>0}function m(){for(var b=0;b<a.types.length;b++)if(a.hasResults(a.types[b].content_type_enum,b)){a.showResult(a.types[b].content_type_enum,b);break}}var n="img-no-min/Lighthouse.png";a.selectedTypeIndex=0,a.selectedCategory,a.showDetailPage=!1,a.selected=0,a.showingResult=!1,a.hideMainSearch=!1,a.relatedSearches,a.defaultErrorImage="../../favicon.ico",a.showTopAnchor=!1,a.itemType,a.itemDetails,a.query,a.showResult=function(b,c){a.selectedTypeIndex=b,a.resultByType=a.types[c]},a.hasResults=function(b,c){switch(b){case"ENTERTAINMENT_VIDEO_MOVIE":return a.types[c]&&a.types[c].searchResultRelcy&&a.types[c].searchResultRelcy.results&&a.types[c].searchResultRelcy.results.length;case"WEB_VIDEOS":return a.types[c]&&a.types[c].videoSearchResult&&a.types[c].videoSearchResult.videoSearchResults&&a.types[c].videoSearchResult.videoSearchResults.length;case"WEB":return a.types[c]&&a.types[c].webSearchResult&&a.types[c].webSearchResult.searchResults&&a.types[c].webSearchResult.searchResults.length;case"APP":return a.types[c]&&a.types[c].searchResultRelcy&&a.types[c].searchResultRelcy.results&&a.types[c].searchResultRelcy.results.length;case"RELATED_SEARCHES":return a.types[c]&&a.types[c].relatedSearchesResult&&a.types[c].relatedSearchesResult.relatedSearchResults&&a.types[c].relatedSearchesResult.relatedSearchResults.length;case"LOCAL_BUSINESS":return a.types[c]&&a.types[c].relatedSearchesResult&&a.types[c].relatedSearchesResult.relatedSearchResults&&a.types[c].relatedSearchesResult.relatedSearchResults.length;default:return!1}},a.addScores=function(a){return a?(angular.forEach(a.auto_complete_response.auto_complete_item,function(a){a.scoreArray=k(a.score),a.showHalfRating=l(a.score)}),a.auto_complete_response):void 0},a.addScoresToAppResluts=function(a){return a?(angular.forEach(a,function(a){a.scoreArray=k(a.app_result[0].score),a.showHalfRating=l(a.app_result[0].score)}),a):void 0},a.addScoresToPlaceResluts=function(a){return a?(angular.forEach(a,function(a){try{var b,c=a.entity_data.common_data.display_rating[0],d=c.rating_style;"STAR"==d?(b=c.rating,a.scoreArray=k(b),a.showHalfRating=l(b)):(a.rating=c.rating+"/"+c.max_rating,a.showStrRating=!0),a.ratingSource=c.source}catch(e){console.log("rating not avlbl for this one")}}),a):void 0},a.addScoresToVideoMovies=function(a){return a?(angular.forEach(a,function(a){var b=a.score/20;a.scoreArray=k(b),a.showHalfRating=l(b)}),a):void 0},a.onInputChange=function(b){a.query=b},a.searchForSelection=function(b){b&&b.title&&a.search(b.title)},a.goForRelatedSearch=function(b){a.$broadcast("angucomplete-alt:clearInput","members"),f(function(){angular.element(document.querySelector("#members")).children().children()[0].value=b},250),a.search(b),a.query=b},a.search=function(b){b&&(c.hideLoader=!1,a.searchResults=void 0,a.relatedSearches=void 0,g.getSearchDetails(b).then(function(b){return a.showDetailPage=!1,a.showingResult=!0,a.result=b.search_response,a.result.verticalResult?(a.searchResults=g.transformSearchResults(a.result.verticalResult,a),a.selectedCategory=a.searchResults[0].key,a.types=a.result.verticalResult,m(),void(c.hideLoader=!0)):void(a.showingResult=!1)},function(b){a.showingResult=!1,a.gridMessage="Error while loading data",c.hideLoader=!0}))},a.reload=function(){window.location.reload()},a.clearSearchInput=function(b){a.hideMainSearch=!1,a.showDetailPage=!1,a.$broadcast("angucomplete-alt:clearInput","members"),a.showingResult=!1,a.$broadcast("angucomplete-alt:clearInput",b)},a.getBaseUrl=function(){return g.BASE_URL},a.gotoLink=function(a){a&&e.open(a,"_blank")},a.scrollTo=function(b){if(a.selectedCategory=b,"container"==b)a.showTopAnchor=!1,a.searchResults.length>0&&(a.selectedCategory=a.searchResults[0].key);else try{a.searchResults[0].key==b?a.showTopAnchor=!1:a.showTopAnchor=!0}catch(c){console.log("nothing there in first category!")}d.hash(b),i.scrollTo(b)},a.onAutoCompleteSelect=function(b){b&&(b.originalObject.lookIds&&b.originalObject.lookIds[0]?a.showDetails(b):a.searchForSelection(b))},a.incrementAndScroll=function(a){a.maxIndex=a.maxIndex+a.incrementBy},a.showDetails=function(b){a.showingResult=!1,a.hideMainSearch=!0,b.content_type_enum?a.itemType=b.content_type_enum:b.originalObject.content_type_enum&&(a.itemType=b.originalObject.content_type_enum);var d;return b.relcy_id&&b.relcy_id.entity_id?d=b.relcy_id:b.originalObject.lookIds&&b.originalObject.lookIds[0]&&(d={entity_id:b.originalObject.lookIds[0],cipher_id:b.originalObject.entity_id}),d?(c.hideLoader=!1,a.showDetailPage=!1,g.getEntityDetails(d).then(function(d){a.showDetailPage=!0,g.selectedItem=b,a.itemDetails=g.transformDetails(d),a.searchResults=a.itemDetails.categories;var e=g.transformQuery(a.itemDetails,a.itemType);g.getBannerUrl(e).then(function(b){b?a.bannerUrl=b:a.bannerUrl=n},function(a){console.log("Error while fetching banner image url")}),a.searchResults.length>0&&(a.selectedCategory=a.searchResults[0].key),c.hideLoader=!0},function(a){console.log("Error while fetching details!!!"),c.hideLoader=!0}),void 0):void console.log("Relcy id not found!")},a.openCastLightbox=function(b,c,d){if(j.type=c,j.data=b,"VIDEO"==c){for(var e=0;e<b.length;e++)try{if(b[e].contentUrl.indexOf("youtube")>-1){var f=b[e].contentUrl.replace("watch?v=","embed/");f+="?autoplay=1",j.data={value:f,title:b[e].title,duration:b[e].duration};break}}catch(g){console.log("something went wrong!")}j.data.value||(j.data={value:b[0].contentUrl})}if("IMAGES"==c){a.images=[];for(var e=0;e<b.length;e++)a.images.push({url:b[e].contentUrl,caption:b[e].title,thumbUrl:b[e].thumbnailUrl,dimensions:b[e].dimensions});j.openModal(a.images,d)}else j.openModal([j.data],0)},e.navigator.geolocation.getCurrentPosition(function(b){a.$apply(function(){g.position=b,console.log(b)})},function(a){}),c.hideSearchDropdown=function(a){angular.element(document.querySelector("#members")).children()[0].classList.remove("angucomplete-dropdown-visible")},c.hideLoader=!0}]),angular.module("relcyApp").service("SearchService",["$timeout","$q","$http",function(a,b,c){this.searchResult=[],this.position,this.BASE_URL="https://staging-w.relcy.com",this.defaultLoc={lat:"37.762759",lng:"-122.408934"};var d=this;this.getGeoLocation=function(){try{return{lat:d.position.coords.latitude,lng:d.position.coords.longitude}}catch(a){return d.defaultLoc}},this.getSearchDetails=function(a){var e=d.getGeoLocation(),f=b.defer();return c.get(d.BASE_URL+"/search?lat="+e.lat+"&lng="+e.lng+"&sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1&query="+a).success(function(a){f.resolve(a)}).error(function(a,b){f.reject(a)}),f.promise},this.getEntityDetails=function(a){var e=(d.getGeoLocation(),b.defer()),f=a;return c({method:"POST",url:d.BASE_URL+"/detail?sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1",data:f}).success(function(a){e.resolve(a)}).error(function(a,b){e.reject(a)}),e.promise},this.getBannerUrl=function(a){var e=b.defer();return c.get(d.BASE_URL+"/imagefetcher?sessionId=b9a30926-e912-11e4-b02c-1681e6b88ec1&query="+a).success(function(a){e.resolve(a)}).error(function(a,b){e.reject(a)}),e.promise},this.transformDetails=function(a){var b={};b.categories=[],a=a.detail_response;try{var c=a.results[0].link;c&&c.length>0&&d.insertReviewsAndWatchesAndShowtimes(b,c,a)}catch(e){console.log("Links not available")}if(a){var f=a.search_result_collection;if(f){if("ENTERTAINMENT_AUDIO"==a.results[0].content_type_enum)try{b.audioResult=a.results[0].content_type_enum,b.categories.push({key:"details_audio",keyTitle:"Audio"})}catch(e){console.log("no audio results found")}else try{b.moviesResult=a.results[0].content_type_enum,b.categories.push({key:"details_movies",keyTitle:"Movies"})}catch(e){console.log("no movie results found")}try{b.webResults=f.webSearchResult.searchResults,b.webResults.maxIndex=10,b.categories.push({key:"details_web",keyTitle:"Web"})}catch(e){console.log("no web results found")}try{b.imageResults=f.imageSearchResult.imageSearchResults,b.imageResults.maxIndex=4,b.categories.push({key:"details_images",keyTitle:"Images"})}catch(e){console.log("no image results found")}try{b.videoResults=f.videoSearchResult.videoSearchResults,b.videoResults.maxIndex=5,b.categories.push({key:"details_videos",keyTitle:"Videos"})}catch(e){console.log("no video results found")}}try{b.duration=a.results[0].entity_data.entertainment_data.movie_data.length}catch(e){console.log("duration unknown")}try{b.releaseYear=a.results[0].entity_data.entertainment_data.common_data.release_year}catch(e){console.log("release year unknown")}try{b.title=a.results[0].entity_data.common_data.name}catch(e){console.log("title not found/unknown")}try{b.story=a.results[0].entity_data.common_data.summary}catch(e){console.log("title not found/unknown")}try{b.parentalRating=a.results[0].entity_data.entertainment_data.common_data.parental_rating}catch(e){console.log("parentalRating not found/unknown")}try{b.cast=a.results[0].entity_data.entertainment_data.common_data.performer}catch(e){console.log("cast not found/unknown")}try{b.cast?b.cast.push(a.results[0].entity_data.entertainment_data.common_data.director):b.cast=[a.results[0].entity_data.entertainment_data.common_data.director]}catch(e){console.log("director not found/unknown")}try{b.genre=a.results[0].entity_data.entertainment_data.common_data.genre.join(),b.genre=b.genre.replace(/&amp;/g,"&")}catch(e){console.log("cast not found/unknown")}}return b},this.transformSearchResults=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d].content_type_enum,f=void 0,g=void 0,h=void 0,i=void 0,j=void 0;switch(e){case"ENTERTAINMENT_VIDEO_MOVIE":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="Movies",h="ENTERTAINMENT_VIDEO_MOVIE",i=4,j=4,b.addScoresToVideoMovies(f));break;case"ENTERTAINMENT_VIDEO_TVSHOW":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="TV Shows",h="ENTERTAINMENT_VIDEO_TVSHOW",i=4,j=4,b.addScoresToVideoMovies(f));break;case"WEB_VIDEOS":a[d]&&a[d].videoSearchResult&&a[d].videoSearchResult.videoSearchResults&&a[d].videoSearchResult.videoSearchResults.length&&(f=a[d].videoSearchResult.videoSearchResults,g="Videos",h="WEB_VIDEOS",i=3,j=3);break;case"WEB_IMAGES":a[d]&&a[d].imageSearchResult&&a[d].imageSearchResult.imageSearchResults&&a[d].imageSearchResult.imageSearchResults.length&&(f=a[d].imageSearchResult.imageSearchResults,g="Images",h="WEB_IMAGES",i=4,j=4);break;case"WEB":a[d]&&a[d].webSearchResult&&a[d].webSearchResult.searchResults&&a[d].webSearchResult.searchResults.length&&(f=a[d].webSearchResult.searchResults,g="Web",h="WEB",i=10,j=10);break;case"WEB_NEWS":a[d]&&a[d].newsSearchResult&&a[d].newsSearchResult.newsSearchResults&&a[d].newsSearchResult.newsSearchResults.length&&(f=a[d].newsSearchResult.newsSearchResults,g="News",h="WEB_NEWS",i=10,j=10);break;case"APP":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="App",h="APP",i=2,j=2,b.addScoresToAppResluts(f));break;case"RELATED_SEARCHES":a[d]&&a[d].relatedSearchesResult&&a[d].relatedSearchesResult.relatedSearchResults&&a[d].relatedSearchesResult.relatedSearchResults.length&&(b.relatedSearches=a[d].relatedSearchesResult.relatedSearchResults),f=void 0;break;case"ENTERTAINMENT_AUDIO":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="Songs",h="ENTERTAINMENT_AUDIO",i=1,j=1,b.addScoresToVideoMovies(f));break;case"LOCAL_BUSINESS":a[d]&&a[d].searchResultRelcy&&a[d].searchResultRelcy.results&&a[d].searchResultRelcy.results.length&&(f=a[d].searchResultRelcy.results,g="Places",h="LOCAL_BUSINESS",i=6,j=6,b.addScoresToPlaceResluts(f));break;default:continue}f&&c.push({key:e,values:f,keyTitle:g,maxIndex:i,incrementBy:j,template:h})}return c},this.insertReviewsAndWatchesAndShowtimes=function(a,b,c){a.reviews=[],a.watches=[],angular.forEach(b,function(b){try{var c=b.app_result.result_data.action;switch(c){case"Reviews":a.reviews.push(b);break;case"Watch":a.watches.push(b)}}catch(d){console.log("invalid link")}});var d=[];try{d=c.results[0].entity_data.entertainment_data.movie_data.tv_showtime.showtimes}catch(e){console.log("No tv shows");try{d=c.results[0].entity_data.entertainment_data.movie_data.theatre_showtime.showtimes}catch(e){console.log("No movie shows")}}a.showTimes=[],angular.forEach(d,function(b){for(var c=[],d=0;d<b.shows.days.length;d++){for(var e,f=new Date(b.shows.days[d].date-0),g=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate(),h=!1,i=0;i<c.length;i++)c[i].strDate==g&&(h=!0,e=c[i]);h?e.hours=e.hours.concat(b.shows.days[d].hours):c.push({title:b.playing_entity.title,strDate:g,hours:b.shows.days[d].hours,date:b.shows.days[d].date})}a.showTimes.push(c)})},this.hasLinkType=function(a,b){for(var c=b.results[0].app_action,d=0;d<c.length;d++)if(c[d]==a)return!0},this.transformQuery=function(a,b){switch(b){case"ENTERTAINMENT_VIDEO_MOVIE":return a.title+"+"+a.releaseYear;case"WEB_VIDEOS":return $scope.types[index]&&$scope.types[index].videoSearchResult&&$scope.types[index].videoSearchResult.videoSearchResults&&$scope.types[index].videoSearchResult.videoSearchResults.length;case"LOCAL_BUSINESS":return $scope.types[index]&&$scope.types[index].relatedSearchesResult&&$scope.types[index].relatedSearchesResult.relatedSearchResults&&$scope.types[index].relatedSearchesResult.relatedSearchResults.length;default:return!1}},this.handleError=function(a){return console.log(a),404==a.status&&"Result not available."==a.data?a:(console.log(a),b.reject(angular.isObject(a.data)&&a.data.message?a:a))},this.handleSuccess=function(a){var b=a.data;return b}}]),angular.module("relcyApp").service("anchorSmoothScroll",function(){this.scrollTo=function(a){function b(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}function c(a){for(var b=document.getElementById(a),c=b.offsetTop,d=b;d.offsetParent&&d.offsetParent!=document.body;)d=d.offsetParent,c+=d.offsetTop;return c}var d=b(),e=c(a),f=e>d?e-d:d-e;if(100>f)return void scrollTo(0,e);var g=Math.round(f/100);g>=20&&(g=20),g=15;var h=Math.round(f/25),i=e>d?d+h:d-h;e-=106;var j=0;if(e>d)for(var k=d;e>k;k+=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i+=h,i>e&&(i=e),j++;else for(var k=d;k>e;k-=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i-=h,e>i&&(i=e),j++}}),angular.module("relcyApp").filter("hourmins",function(){return function(a){if(a){var b=a.indexOf("min");if(a.indexOf("hr")>0)return a;if(b>0){var c=parseInt(a.substring(0,b),0),d=Math.floor(c/60),e="";return d>0&&(e+=d+" hr "),e=e+c%60+" min"}var f=parseInt(a,0),d=Math.floor(f/60),e="";return d>0&&(e+=d+" hr "),e=e+f%60+" min"}}}),angular.module("relcyApp").directive("errSrc",function(){return{link:function(a,b,c){b.bind("error",function(){c.src!=c.errSrc&&c.$set("src",c.errSrc)}),c.$observe("ngSrc",function(a){!a&&c.errSrc&&c.$set("src",c.errSrc)})}}});